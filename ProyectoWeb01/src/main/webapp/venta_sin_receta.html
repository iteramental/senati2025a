<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Venta sin Receta - M√≥dulo Farmacia</title>
  <link rel="stylesheet" href="estilos_farmacia.css">
</head>
<body>

  <header>
    <h1>üè• Venta de Medicamentos</h1>
  </header>

  <div class="main-container">
    
    <!-- Navegaci√≥n de tipos de venta -->
    <div class="nav-tabs">
      <button class="tab-button" onclick="location.href='venta_receta.html'">üìã Venta por Receta</button>
      <button class="tab-button active">üõí Venta sin Receta</button>
    </div>

    <!-- Barra de b√∫squeda de paciente -->
    <div class="search-container">
      <div class="search-card">
        <div class="search-header">
          <span class="search-icon">üë§</span>
          <h3 class="search-title">Buscar Paciente</h3>
        </div>
        <div class="search-form">
          <input type="text" id="pacienteDni" class="search-input" placeholder="Ingrese el DNI del paciente" maxlength="8">
          <button class="search-button" onclick="buscarPaciente()">üîç Buscar</button>
          <button class="clear-button" onclick="limpiarBusqueda()">üóëÔ∏è Limpiar</button>
        </div>
        <div id="searchMessage" class="search-message"></div>
      </div>
    </div>

    <!-- Grid de contenido -->
    <div class="content-grid">
      
      <!-- Datos del Paciente -->
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üë§</span>
          <h3 class="card-title">Informaci√≥n del Paciente</h3>
        </div>
        <div class="patient-grid" id="patientData">
          <div class="info-item">
            <span class="info-label">DNI:</span>
            <input type="text" id="dniInput" class="info-input" placeholder="Ingrese DNI" maxlength="8">
          </div>
          <div class="info-item">
            <span class="info-label">Nombre:</span>
            <input type="text" id="nombreInput" class="info-input" placeholder="Ingrese nombre" maxlength="50">
          </div>
          <div class="info-item">
            <span class="info-label">Apellido:</span>
            <input type="text" id="apellidoInput" class="info-input" placeholder="Ingrese apellido" maxlength="50">
          </div>
          <div class="info-item">
            <span class="info-label">Tel√©fono:</span>
            <input type="text" id="telefonoInput" class="info-input" placeholder="Ingrese tel√©fono" maxlength="9">
          </div>
          <div class="info-item">
            <span class="info-label">Direcci√≥n:</span>
            <input type="text" id="direccionInput" class="info-input" placeholder="Ingrese direcci√≥n" maxlength="100">
          </div>
          <div class="info-item">
            <span class="info-label">Correo:</span>
            <input type="email" id="correoInput" class="info-input" placeholder="Ingrese correo" maxlength="100">
          </div>
        </div>
      </div>

      <!-- B√∫squeda de Productos -->
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üíä</span>
          <h3 class="card-title">Buscar Medicamentos</h3>
        </div>
        <div class="search-form">
          <input type="text" id="medicamentoNombre" class="search-input" placeholder="Buscar medicamento (ej: Paracetamol)" maxlength="50">
          <button class="search-button" onclick="buscarMedicamento()">üîç Buscar</button>
        </div>
        <div id="medicamentoMessage" class="search-message"></div>
        
        <!-- Resultados de b√∫squeda -->
        <div id="medicamentoResultados" class="medicamento-resultados" style="display: none;">
          <h4>Medicamentos Encontrados:</h4>
          <div class="table-container">
            <table class="products-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Stock</th>
                  <th>Precio Unitario</th>
                  <th>Cantidad</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="medicamentosList">
                <!-- Resultados se cargar√°n aqu√≠ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Carrito de Compras -->
      <div class="card full-width">
        <div class="card-header">
          <span class="card-icon">üõí</span>
          <h3 class="card-title">Carrito de Compras</h3>
        </div>
        
        <div class="table-container">
          <table class="products-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Subtotal</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="carritoList">
              <tr id="carritoVacio">
                <td colspan="5" style="text-align: center; color: #999; padding: 30px;">
                  üõí El carrito est√° vac√≠o
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td colspan="3" class="total-label">TOTAL A PAGAR:</td>
                <td colspan="2" class="total-amount" id="totalAmount">S/ 0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- Bot√≥n de acci√≥n principal -->
    <div class="button-container">
      <button class="primary-button" onclick="registrarVenta()" id="btnRegistrar" disabled>
        ‚úÖ Registrar Venta
      </button>
    </div>
  </div>

  <script>
    // Variables globales
    let carrito = [];
    let totalVenta = 0;
    let pacienteRegistrado = false;

    // Base de datos simulada de medicamentos
    const medicamentos = [
      { id: 1, nombre: "Paracetamol 500mg", descripcion: "Analg√©sico - Tabletas", stock: 100, precio: 8.50 },
      { id: 2, nombre: "Ibuprofeno 400mg", descripcion: "Analg√©sico - Tabletas", stock: 50, precio: 9.80 },
      { id: 3, nombre: "Aspirina 100mg", descripcion: "Anticoagulante - Tabletas", stock: 75, precio: 12.00 },
      { id: 4, nombre: "Paracetamol 750mg", descripcion: "Analg√©sico - Tabletas", stock: 80, precio: 10.50 },
      { id: 5, nombre: "Amoxicilina 500mg", descripcion: "Antibi√≥tico - C√°psulas", stock: 30, precio: 12.50 },
      { id: 6, nombre: "Omeprazol 20mg", descripcion: "Anti√°cido - C√°psulas", stock: 60, precio: 15.00 },
      { id: 7, nombre: "Loratadina 10mg", descripcion: "Antihistam√≠nico - Tabletas", stock: 40, precio: 18.00 }
    ];

    // Pacientes registrados simulados
    const pacientes = {
      "12345678": {
        dni: "12345678",
        nombre: "Mar√≠a",
        apellido: "Garc√≠a",
        telefono: "987654321",
        direccion: "Av. Lima 456",
        correo: "maria.garcia@email.com"
      },
      "87654321": {
        dni: "87654321",
        nombre: "Carlos",
        apellido: "Rodr√≠guez",
        telefono: "912345678",
        direccion: "Jr. Cusco 789",
        correo: "carlos.rodriguez@email.com"
      }
    };

    function buscarPaciente() {
      const dni = document.getElementById("pacienteDni").value.trim();
      const mensaje = document.getElementById("searchMessage");

      if (dni === "") {
        mensaje.textContent = "‚ö†Ô∏è Por favor, ingresa un DNI.";
        mensaje.style.color = "#f44336";
        return;
      }

      if (pacientes[dni]) {
        const paciente = pacientes[dni];
        mensaje.textContent = "‚úÖ Paciente encontrado exitosamente.";
        mensaje.style.color = "#2e7d32";
        
        // Llenar campos con datos del paciente
        document.getElementById("dniInput").value = paciente.dni;
        document.getElementById("nombreInput").value = paciente.nombre;
        document.getElementById("apellidoInput").value = paciente.apellido;
        document.getElementById("telefonoInput").value = paciente.telefono;
        document.getElementById("direccionInput").value = paciente.direccion;
        document.getElementById("correoInput").value = paciente.correo;

        // Deshabilitar campos para paciente registrado
        document.getElementById("dniInput").disabled = true;
        document.getElementById("nombreInput").disabled = true;
        document.getElementById("apellidoInput").disabled = true;
        
        pacienteRegistrado = true;
        verificarBotonRegistrar();
      } else {
        mensaje.textContent = "‚ö†Ô∏è Paciente no encontrado. Complete los datos para nuevo paciente.";
        mensaje.style.color = "#ff9800";
        
        // Limpiar campos
        document.getElementById("dniInput").value = dni;
        document.getElementById("nombreInput").value = "";
        document.getElementById("apellidoInput").value = "";
        document.getElementById("telefonoInput").value = "";
        document.getElementById("direccionInput").value = "";
        document.getElementById("correoInput").value = "";

        // Habilitar campos para nuevo paciente
        document.getElementById("dniInput").disabled = false;
        document.getElementById("nombreInput").disabled = false;
        document.getElementById("apellidoInput").disabled = false;
        
        pacienteRegistrado = false;
        verificarBotonRegistrar();
      }
    }

    function limpiarBusqueda() {
      document.getElementById("pacienteDni").value = "";
      document.getElementById("searchMessage").textContent = "";
      
      // Limpiar campos del paciente
      document.getElementById("dniInput").value = "";
      document.getElementById("nombreInput").value = "";
      document.getElementById("apellidoInput").value = "";
      document.getElementById("telefonoInput").value = "";
      document.getElementById("direccionInput").value = "";
      document.getElementById("correoInput").value = "";

      // Habilitar campos
      document.getElementById("dniInput").disabled = false;
      document.getElementById("nombreInput").disabled = false;
      document.getElementById("apellidoInput").disabled = false;
      
      pacienteRegistrado = false;
      verificarBotonRegistrar();
    }

    function buscarMedicamento() {
      const nombre = document.getElementById("medicamentoNombre").value.trim();
      const mensaje = document.getElementById("medicamentoMessage");
      const resultados = document.getElementById("medicamentoResultados");
      const lista = document.getElementById("medicamentosList");

      if (nombre === "") {
        mensaje.textContent = "‚ö†Ô∏è Por favor, ingresa el nombre del medicamento.";
        mensaje.style.color = "#f44336";
        resultados.style.display = "none";
        return;
      }

      // Buscar medicamentos que contengan el nombre
      const encontrados = medicamentos.filter(med => 
        med.nombre.toLowerCase().includes(nombre.toLowerCase())
      );

      if (encontrados.length > 0) {
        mensaje.textContent = `‚úÖ ${encontrados.length} medicamento(s) encontrado(s).`;
        mensaje.style.color = "#2e7d32";
        
        // Mostrar resultados
        lista.innerHTML = "";
        encontrados.forEach(med => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div class="product-info">
                <strong>${med.nombre}</strong>
                <small>${med.descripcion}</small>
              </div>
            </td>
            <td>
              <span class="quantity-badge">${med.stock}</span>
            </td>
            <td>S/ ${med.precio.toFixed(2)}</td>
            <td>
              <input type="number" min="1" max="${med.stock}" value="1" class="quantity-input" id="qty-${med.id}">
            </td>
            <td>
              <button class="action-btn" onclick="agregarAlCarrito(${med.id})" style="background: #4caf50; color: white;">‚ûï Agregar</button>
            </td>
          `;
          lista.appendChild(row);
        });
        
        resultados.style.display = "block";
      } else {
        mensaje.textContent = "‚ùå No se encontraron medicamentos.";
        mensaje.style.color = "#f44336";
        resultados.style.display = "none";
      }
    }

    function agregarAlCarrito(medicamentoId) {
      const medicamento = medicamentos.find(m => m.id === medicamentoId);
      const cantidad = parseInt(document.getElementById(`qty-${medicamentoId}`).value);
      
      if (cantidad > medicamento.stock) {
        alert("‚ùå Cantidad solicitada excede el stock disponible.");
        return;
      }

      // Verificar si ya existe en el carrito
      const existeEnCarrito = carrito.find(item => item.id === medicamentoId);
      
      if (existeEnCarrito) {
        existeEnCarrito.cantidad += cantidad;
        existeEnCarrito.subtotal = existeEnCarrito.cantidad * existeEnCarrito.precio;
      } else {
        carrito.push({
          id: medicamentoId,
          nombre: medicamento.nombre,
          descripcion: medicamento.descripcion,
          precio: medicamento.precio,
          cantidad: cantidad,
          subtotal: cantidad * medicamento.precio
        });
      }

      actualizarCarrito();
      
      // Mostrar mensaje de √©xito
      const mensaje = document.getElementById("medicamentoMessage");
      mensaje.textContent = "‚úÖ Medicamento agregado al carrito.";
      mensaje.style.color = "#2e7d32";
      
      setTimeout(() => {
        mensaje.textContent = "";
      }, 2000);
    }

    function actualizarCarrito() {
      const lista = document.getElementById("carritoList");
      const carritoVacio = document.getElementById("carritoVacio");
      
      if (carrito.length === 0) {
        carritoVacio.style.display = "table-row";
      } else {
        carritoVacio.style.display = "none";
        
        lista.innerHTML = "";
        totalVenta = 0;
        
        carrito.forEach((item, index) => {
          totalVenta += item.subtotal;
          
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>
              <div class="product-info">
                <strong>${item.nombre}</strong>
                <small>${item.descripcion}</small>
              </div>
            </td>
            <td>
              <input type="number" min="1" value="${item.cantidad}" class="quantity-input" onchange="actualizarCantidad(${index}, this.value)">
            </td>
            <td>S/ ${item.precio.toFixed(2)}</td>
            <td class="subtotal">S/ ${item.subtotal.toFixed(2)}</td>
            <td>
              <button class="action-btn edit-btn" onclick="editarItem(${index})">‚úèÔ∏è</button>
              <button class="action-btn delete-btn" onclick="eliminarDelCarrito(${index})">üóëÔ∏è</button>
            </td>
          `;
          lista.appendChild(row);
        });
        
        lista.appendChild(carritoVacio);
      }
      
      document.getElementById("totalAmount").textContent = `S/ ${totalVenta.toFixed(2)}`;
      verificarBotonRegistrar();
    }

    function actualizarCantidad(index, nuevaCantidad) {
      const cantidad = parseInt(nuevaCantidad);
      if (cantidad > 0) {
        carrito[index].cantidad = cantidad;
        carrito[index].subtotal = cantidad * carrito[index].precio;
        actualizarCarrito();
      }
    }

    function eliminarDelCarrito(index) {
      carrito.splice(index, 1);
      actualizarCarrito();
    }

    function editarItem(index) {
      const nuevaCantidad = prompt("Ingrese la nueva cantidad:", carrito[index].cantidad);
      if (nuevaCantidad && parseInt(nuevaCantidad) > 0) {
        actualizarCantidad(index, nuevaCantidad);
      }
    }

    function verificarBotonRegistrar() {
      const btnRegistrar = document.getElementById("btnRegistrar");
      const dniValido = document.getElementById("dniInput").value.trim() !== "";
      const nombreValido = document.getElementById("nombreInput").value.trim() !== "";
      const apellidoValido = document.getElementById("apellidoInput").value.trim() !== "";
      const telefonoValido = document.getElementById("telefonoInput").value.trim() !== "";
      const direccionValida = document.getElementById("direccionInput").value.trim() !== "";
      const carritoLleno = carrito.length > 0;

      const datosCompletos = dniValido && nombreValido && apellidoValido && telefonoValido && direccionValida;
      
      if (datosCompletos && carritoLleno) {
        btnRegistrar.disabled = false;
        btnRegistrar.style.opacity = "1";
      } else {
        btnRegistrar.disabled = true;
        btnRegistrar.style.opacity = "0.5";
      }
    }

    // Agregar listeners para validar formulario
    document.addEventListener("DOMContentLoaded", function() {
      const inputs = ["dniInput", "nombreInput", "apellidoInput", "telefonoInput", "direccionInput"];
      inputs.forEach(inputId => {
        document.getElementById(inputId).addEventListener("input", verificarBotonRegistrar);
      });
    });

    function registrarVenta() {
      if (carrito.length === 0) {
        alert("‚ùå El carrito est√° vac√≠o.");
        return;
      }

      const button = document.querySelector('.primary-button');
      const originalText = button.textContent;
      
      button.textContent = '‚úÖ Procesando...';
      button.disabled = true;
      
      setTimeout(() => {
        button.textContent = 'üéâ Venta Registrada Exitosamente';
        
        // Limpiar carrito y datos
        setTimeout(() => {
          carrito = [];
          totalVenta = 0;
          actualizarCarrito();
          limpiarBusqueda();
          
          // Limpiar b√∫squeda de medicamentos
          document.getElementById("medicamentoNombre").value = "";
          document.getElementById("medicamentoMessage").textContent = "";
          document.getElementById("medicamentoResultados").style.display = "none";
          
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      }, 1500);
    }
  </script>

  <style>
    .info-input {
      background: rgba(227, 242, 253, 0.8);
      padding: 8px 15px;
      border-radius: 8px;
      color: #0d47a1;
      font-weight: 500;
      flex: 1;
      border: 2px solid rgba(144, 202, 249, 0.4);
      font-size: 14px;
    }

    .info-input:focus {
      outline: none;
      border-color: #42a5f5;
      background: #e3f2fd;
    }

    .info-input:disabled {
      background: rgba(200, 200, 200, 0.3);
      color: #666;
    }

    .quantity-input {
      width: 80px;
      padding: 6px 8px;
      border: 2px solid rgba(144, 202, 249, 0.5);
      border-radius: 6px;
      text-align: center;
      font-size: 14px;
    }

    .quantity-input:focus {
      outline: none;
      border-color: #42a5f5;
    }

    .medicamento-resultados {
      margin-top: 20px;
    }

    .medicamento-resultados h4 {
      color: #1565c0;
      margin-bottom: 15px;
      font-size: 16px;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(144, 202, 249, 0.5);
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin: 0 3px;
      transition: all 0.3s ease;
    }

    .action-btn:hover {
      transform: translateY(-1px);
    }

    .primary-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
  </style>

</body>
</html>