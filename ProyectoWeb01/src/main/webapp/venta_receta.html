<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Venta por Receta - M√≥dulo Farmacia</title>
  <link rel="stylesheet" href="estilos_farmacia.css">
</head>
<body>

  <header>
    <h1>üè• Venta de Medicamentos</h1>
  </header>

  <div class="main-container">
    <div class="nav-tabs">        
      <div class="button-container" style="margin-bottom: 30px; text-align: left;">
        <a href="dashboard_farmacia.html" class="primary-button" style="padding: 12px 25px; display: inline-flex; align-items: center; text-decoration: none;">
          ‚Üê Volver
        </a>
      </div>
      <button class="tab-button active">üìã Venta por Receta</button>
      <button class="tab-button" onclick="location.href='venta_sin_receta.html'">üõí Venta sin Receta</button>
    </div>

    <!-- Buscador -->
    <div class="search-container">
      <div class="search-card">
        <div class="search-header">
          <span class="search-icon">üîç</span>
          <h3 class="search-title">Buscar Receta</h3>
        </div>
        <div class="search-form">
          <input type="text" id="recetaId" class="search-input" placeholder="Ingrese el ID de la receta (ej: REC-001)" maxlength="20">
          <button class="search-button" onclick="buscarReceta()">üîç Buscar</button>
          <button class="clear-button" onclick="limpiarBusqueda()">üóëÔ∏è Limpiar</button>
        </div>
        <div id="searchMessage" class="search-message"></div>
      </div>
    </div>

    <!-- CONTENIDO OCULTO AL INICIO -->
    <div class="venta-container" style="display: none;">

      <!-- Grid de contenido -->
      <div class="content-grid">
        
        <!-- Informaci√≥n de la Receta -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">üìÑ</span>
            <h3 class="card-title">Informaci√≥n de la Receta</h3>
          </div>
          <div class="info-container">
            <div class="info-item">
              <span class="info-label">N√∫mero de Receta:</span>
              <span class="info-value receta-id"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Fecha de Emisi√≥n:</span>
              <span class="info-value fecha-emision"></span>
            </div>
          </div>
        </div>

        <!-- Datos del M√©dico -->
        <div class="card">
          <div class="card-header">
            <span class="card-icon">üë®‚Äç‚öïÔ∏è</span>
            <h3 class="card-title">M√©dico Tratante</h3>
          </div>
          <div class="info-container">
            <div class="info-item">
              <span class="info-label">Nombre:</span>
              <span class="info-value medico-nombre"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Apellido:</span>
              <span class="info-value medico-apellido"></span>
            </div>
          </div>
        </div>

        <!-- Datos del Paciente -->
        <div class="card full-width">
          <div class="card-header">
            <span class="card-icon">üë§</span>
            <h3 class="card-title">Informaci√≥n del Paciente</h3>
          </div>
          <div class="patient-grid">
            <div class="info-item">
              <span class="info-label">Nombre:</span>
              <span class="info-value paciente-nombre"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Apellido:</span>
              <span class="info-value paciente-apellido"></span>
            </div>
            <div class="info-item">
              <span class="info-label">DNI:</span>
              <span class="info-value paciente-dni"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Fecha de Nac:</span>
              <span class="info-value paciente-nac"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Tel√©fono:</span>
              <span class="info-value paciente-telefono"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Correo:</span>
              <span class="info-value paciente-correo"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Direcci√≥n:</span>
              <span class="info-value paciente-direccion"></span>
            </div>
          </div>

          <!-- Confirmaci√≥n debajo de los datos -->
          <div class="confirm-container" id="confirmContainer">
            <p>¬øEs este el paciente correcto?</p>
            <div class="confirm-buttons">
              <button class="confirm" onclick="confirmarPaciente()">‚úÖ S√≠, continuar</button>
              <button class="decline" onclick="declinarPaciente()">‚ùå No es el paciente</button>
            </div>
          </div>
        </div>

        <!-- Productos Recetados -->
        <div class="card full-width productos-container" style="display:none;">
          <div class="card-header">
            <span class="card-icon">üíä</span>
            <h3 class="card-title">Productos Recetados</h3>
          </div>
          <div class="table-container">
            <table class="products-table">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Precio Unitario</th>
                  <th>Subtotal</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    <div class="product-info">
                      <strong>Amoxicilina 500mg</strong>
                      <small>Antibi√≥tico - C√°psulas</small>
                    </div>
                  </td>
                  <td><span class="quantity-badge">2</span></td>
                  <td>S/ 12.50</td>
                  <td class="subtotal">S/ 25.00</td>
                  <td>
                    <button class="action-btn edit-btn">‚úèÔ∏è</button>
                    <button class="action-btn delete-btn">üóëÔ∏è</button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <div class="product-info">
                      <strong>Ibuprofeno 400mg</strong>
                      <small>Analg√©sico - Tabletas</small>
                    </div>
                  </td>
                  <td><span class="quantity-badge">1</span></td>
                  <td>S/ 9.80</td>
                  <td class="subtotal">S/ 9.80</td>
                  <td>
                    <button class="action-btn edit-btn">‚úèÔ∏è</button>
                    <button class="action-btn delete-btn">üóëÔ∏è</button>
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="total-label">TOTAL A PAGAR:</td>
                  <td colspan="2" class="total-amount">S/ 34.80</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Bot√≥n de acci√≥n principal -->
        <div class="button-container productos-container" style="display:none;">
          <button class="primary-button" onclick="registrarVenta()">
            ‚úÖ Registrar Venta
          </button>
        </div>

      </div>
    </div>
  </div>

  <script>
    let recetaEncontrada = false;

    function buscarReceta() {
      const recetaId = document.getElementById("recetaId").value.trim();
      const mensaje = document.getElementById("searchMessage");

      if (recetaId === "") {
        mensaje.textContent = "‚ö†Ô∏è Por favor, ingresa un ID de receta.";
        mensaje.style.color = "#f44336";
        return;
      }

      if (recetaId === "REC-001") {
        recetaEncontrada = true;

        mensaje.textContent = ""; // limpiar mensaje congelado

        // Simular datos del paciente en memoria
        window.datosPaciente = {
          nombre: "Juan",
          apellido: "P√©rez",
          dni: "1000001",
          fechaNac: "1985-01-15",
          telefono: "987654321",
          correo: "juan.perez1@email.com",
          direccion: "Av. Per√∫ 123",
          recetaId: recetaId,
          fechaEmision: "2025-02-01",
          medicoNombre: "Luis",
          medicoApellido: "Gonz√°lez"
        };

        // Mostrar contenedor de datos
        document.querySelector(".venta-container").style.display = "block";
        document.getElementById("confirmContainer").style.display = "block";

        // Llenar datos
        document.querySelector(".receta-id").textContent = window.datosPaciente.recetaId;
        document.querySelector(".fecha-emision").textContent = window.datosPaciente.fechaEmision;
        document.querySelector(".medico-nombre").textContent = window.datosPaciente.medicoNombre;
        document.querySelector(".medico-apellido").textContent = window.datosPaciente.medicoApellido;
        document.querySelector(".paciente-nombre").textContent = window.datosPaciente.nombre;
        document.querySelector(".paciente-apellido").textContent = window.datosPaciente.apellido;
        document.querySelector(".paciente-dni").textContent = window.datosPaciente.dni;
        document.querySelector(".paciente-nac").textContent = window.datosPaciente.fechaNac;
        document.querySelector(".paciente-telefono").textContent = window.datosPaciente.telefono;
        document.querySelector(".paciente-correo").textContent = window.datosPaciente.correo;
        document.querySelector(".paciente-direccion").textContent = window.datosPaciente.direccion;

      } else {
        mensaje.textContent = "‚ùå Receta no encontrada.";
        mensaje.style.color = "#f44336";
        document.querySelector(".venta-container").style.display = "none";
      }
    }

    function confirmarPaciente() {
      const paciente = window.datosPaciente;

      if (paciente.dni === "1000001") {
        document.querySelectorAll(".productos-container").forEach(e => e.style.display = "block");
        document.getElementById("confirmContainer").style.display = "none";
        document.getElementById("searchMessage").textContent = "";
      } else {
        const mensaje = document.getElementById("searchMessage");
        mensaje.innerHTML = `<span style="color: #f44336;">‚ùå Paciente no encontrado.</span> 
          <button onclick="registrarNuevoPaciente()">‚ûï Registrar Paciente</button>`;
        document.querySelector(".venta-container").style.display = "none";
      }
    }

    function declinarPaciente() {
      limpiarBusqueda();
      document.querySelector(".venta-container").style.display = "none";
      document.querySelectorAll(".productos-container").forEach(e => e.style.display = "none");
      document.getElementById("confirmContainer").style.display = "none";
    }

    function limpiarBusqueda() {
      document.getElementById("recetaId").value = "";
      document.getElementById("searchMessage").textContent = "";
    }

    function registrarNuevoPaciente() {
      alert("Redirigiendo al formulario de registro de paciente...");
      // window.location.href = "registro_paciente.html";
    }

    function registrarVenta() {
      const button = document.querySelector('.primary-button');
      const originalText = button.textContent;

      button.textContent = '‚úÖ Procesando...';
      button.disabled = true;

      setTimeout(() => {
        button.textContent = 'üéâ Venta Registrada Exitosamente';
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 2000);
      }, 1500);
    }document.addEventListener("DOMContentLoaded", () => {
  document.querySelector(".products-table").addEventListener("click", function(e) {
    if (e.target.closest(".edit-btn")) {
      handleEdit(e.target.closest("tr"));
    }
    if (e.target.closest(".delete-btn")) {
      handleDelete(e.target.closest("tr"));
    }
  });
});
function handleEdit(row) {
  const qtyCell = row.querySelector(".quantity-badge");
  const priceCell = row.cells[2];
  const subtotalCell = row.querySelector(".subtotal");

  let currentQty = parseInt(qtyCell.textContent, 10);
  let newQty = prompt("Ingrese la nueva cantidad:", currentQty);

  if (newQty === null) return; // cancelado

  newQty = parseInt(newQty, 10);

  if (isNaN(newQty) || newQty <= 0) {
    alert("Cantidad inv√°lida.");
    return;
  }

  // Actualizar cantidad
  qtyCell.textContent = newQty;

  // Calcular nuevo subtotal
  let price = parseFloat(priceCell.textContent.replace(/[^\d.]/g, ""));
  let newSubtotal = (price * newQty).toFixed(2);
  subtotalCell.textContent = `S/ ${newSubtotal}`;

  // Recalcular total
  recalculateTotal();
}

function handleDelete(row) {
  if (confirm("¬øDeseas eliminar este producto?")) {
    row.remove();
    recalculateTotal();
  }
}

function recalculateTotal() {
  let total = 0;
  document.querySelectorAll(".products-table tbody tr").forEach(tr => {
    const subtotalCell = tr.querySelector(".subtotal");
    if (subtotalCell) {
      let subtotal = parseFloat(subtotalCell.textContent.replace(/[^\d.]/g, ""));
      total += subtotal;
    }
  });
  document.querySelector(".total-amount").textContent = `S/ ${total.toFixed(2)}`;
}
  </script>
</body>
</html>
